{% extends 'dashboard/base.html' %}
{% load static %}
{% block main %}

  <header class="topbar">
    <h1 class="h5 mb-0">Analytics</h1>
  </header>

  <section class="container py-4">
    <!-- Metric cards reused from dashboard -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-sm-6 col-lg-4 col-xl-2">
        <div class="card shadow-sm">
          <div class="card-body stat">
            <div class="stat-title">Total Items</div>
            <div class="stat-value">{{ metrics.total_items }}</div>
            <div class="stat-delta text-success"><i class="bi bi-arrow-up-right"></i></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4 col-xl-2">
        <div class="card shadow-sm">
          <div class="card-body stat">
            <div class="stat-title">Low Stock</div>
            <div class="stat-value">{{ metrics.low_stock }}</div>
            <div class="stat-delta text-warning"><i class="bi bi-exclamation-circle"></i> Monitor</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4 col-xl-2">
        <div class="card shadow-sm">
          <div class="card-body stat">
            <div class="stat-title">Out of Stock</div>
            <div class="stat-value">{{ metrics.out_of_stock }}</div>
            <div class="stat-delta text-danger"><i class="bi bi-dash-circle"></i> Reorder</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4 col-xl-2">
        <div class="card shadow-sm">
          <div class="card-body stat">
            <div class="stat-title">Inventory Value</div>
            <div class="stat-value">${{ metrics.inventory_value }}</div>
            <div class="stat-delta text-success"><i class="bi bi-arrow-up-right"></i></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4 col-xl-2">
        <div class="card shadow-sm">
          <div class="card-body stat">
            <div class="stat-title">New Items (7d)</div>
            <div class="stat-value">{{ metrics.new_items_7d }}</div>
            <div class="stat-delta text-success"><i class="bi bi-check-circle"></i> OK</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4 col-xl-2">
        <div class="card shadow-sm">
          <div class="card-body stat">
            <div class="stat-title">Categories</div>
            <div class="stat-value">{{ metrics.categories }}</div>
            <div class="stat-delta text-muted"><i class="bi bi-three-dots"></i></div>
          </div>
        </div>
      </div>
    </div>

    <section class="content container-fluid px-3 px-lg-4 py-3">
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title mb-3">Inventory Value Over Time</h5>
          <canvas id="valueOverTime" height="120"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">Stock Status Trends</h5>
          <canvas id="statusTrends" height="120"></canvas>
        </div>
      </div>
    </section>

    <!-- Charts -->
    <div class="row g-3">
      <div class="col-12 col-xl-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h2 class="h6 mb-3">Items by Stock Status</h2>
            <canvas id="statusChart" height="160"></canvas>
          </div>
        </div>
      </div>
      <div class="col-12 col-xl-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h2 class="h6 mb-3">Items by Category</h2>
            <canvas id="categoryChart" height="160"></canvas>
          </div>
        </div>
      </div>
    </div>

  </section>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  {% comment %} <script src="{% static 'app.js' %}"></script> {% endcomment %}
  <script>
    // Chart for stock status distribution
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    const statusChart = new Chart(statusCtx, {
      type: 'bar',
      data: {
        labels: ['In Stock', 'Low Stock', 'Out of Stock'],
        datasets: [{
          data: [{{ in_stock_count }}, {{ low_stock_count }}, {{ out_stock_count }}],
          backgroundColor: ['#198754', '#FFC107', '#DC3545'],
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 } }
        }
      }
    });

    // Chart for category distribution
    const catCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryLabels = [{% for c in cat_counts %}'{{ c.name }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
    const categoryData = [{% for c in cat_counts %}{{ c.total }}{% if not forloop.last %}, {% endif %}{% endfor %}];

    const categoryChart = new Chart(catCtx, {
      type: "pie",
      data: {
        labels: categoryLabels,
        datasets: [{ 
          label: "Items",
          data: categoryData,
          backgroundColor: [
            '#c09117', '#2a6e5a', '#b94411', '#a2b53b',
            '#de0050', '#aa4489', '#d144cb', '#236012',
            '#e06620ff', '#db3037'
          ],
        }],
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { 
          y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
          x: { grid: { display: false } }
        },
      },
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
      const elStatus = document.getElementById("statusTrends");
      const elValue = document.getElementById("valueOverTime");

      loadAnalyticsCharts(elStatus, elValue);
    });

    async function loadAnalyticsCharts(elStatus, elValue) {
      if (!elStatus && !elValue) return;
      if (!window.InventroAPI || !window.Chart) return;
      
      try {
        const m = await InventroAPI.getMetrics();
        
        if (elStatus) {
          // Destroy existing chart if it exists
          if (window.statusTrendsChart?.destroy) {
            window.statusTrendsChart.destroy();
          }
          window.statusTrendsChart = new Chart(elStatus, {
            type: "line",
            data: {
              labels: m.statusTrends.labels,
              datasets: (m.statusTrends.series || []).map((s, idx) => ({
                label: s.label,
                data: s.data,
                tension: 0.3,
                borderColor: idx === 0 ? 'rgb(75, 192, 192)' : idx === 1 ? 'rgb(255, 206, 86)' : 'rgb(255, 99, 132)',
                backgroundColor: idx === 0 ? 'rgba(75, 192, 192, 0.1)' : idx === 1 ? 'rgba(255, 206, 86, 0.1)' : 'rgba(255, 99, 132, 0.1)',
              })),
            },
            options: {
              responsive: true,
              interaction: { mode: "nearest", intersect: false },
              plugins: {
                legend: { display: true, position: 'top' }
              },
              scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                x: { grid: { display: false } }
              }
            },
          });
        }
        
        if (elValue) {
          // Destroy existing chart if it exists
          if (window.valueOverTimeChart?.destroy) {
            window.valueOverTimeChart.destroy();
          }
          window.valueOverTimeChart = new Chart(elValue, {
            type: "line",
            data: {
              labels: m.valueOverTime.labels,
              datasets: [
                {
                  label: "Inventory Value",
                  data: m.valueOverTime.data,
                  fill: true,
                  borderColor: 'rgb(75, 192, 192)',
                  backgroundColor: 'rgba(75, 192, 192, 0.2)',
                  tension: 0.4,
                },
              ],
            },
            options: { 
              responsive: true, 
              plugins: { legend: { display: false } },
              scales: {
                y: { 
                  beginAtZero: false,
                  grid: { color: 'rgba(0,0,0,0.05)' },
                  ticks: {
                    callback: function(value) {
                      if (value >= 1000) {
                        return '$' + (value / 1000).toFixed(1) + 'k';
                      }
                      return '$' + value.toFixed(0);
                    }
                  }
                },
                x: { grid: { display: false } }
              }
            },
          });
        }
      } catch (e) {
        console.warn("Analytics metrics fallback in use", e);
      }
    }

  </script>
{% endblock %}