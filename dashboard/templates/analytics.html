{% extends "base.html" %}
{% load static %}
{% block content %}
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-icon"><i class="bi bi-box-seam"></i></div>
        <div>
          <div class="brand-title">Inventro</div>
          <div class="brand-sub">Inventory Platform</div>
        </div>
      </div>
      <nav class="menu">
        {% if user.is_authenticated and user.is_superuser %}
          <a class="menu-link" href="{% url 'add_user' %}"><i class="bi bi-person-plus"></i> Add User</a>
        {% endif %}
        <div class="menu-heading">Main</div>
        <a class="menu-link" href="{% url 'dashboard' %}"><i class="bi bi-speedometer2"></i> Dashboard</a>
        <a class="menu-link" href="{% url 'inventory' %}"><i class="bi bi-archive"></i> Inventory</a>
        {% if user.is_superuser or user.is_authenticated and user.is_staff %}
          <a class="menu-link" href="{% url 'add_item' %}"><i class="bi bi-plus-circle"></i> Add Item</a>
        {% endif %}
        {% if user.is_authenticated and user.is_superuser %}
          <a class="menu-link active" href="{% url 'analytics' %}"><i class="bi bi-graph-up"></i> Analytics</a>
        {% endif %}
      </nav>
      <div class="sidebar-footer">
        <div class="avatar">{{ user.username|slice:":2"|upper }}</div>
        <div class="user-meta">
          <div class="user-name">
            {% if user.is_authenticated %}{{ user.username }}{% else %}Guest{% endif %}
          </div>
          <div class="user-role">
            {% if user.is_superuser %}Admin
            {% elif user.is_staff %}Manager
            {% elif user.is_authenticated %}Staff
            {% else %}Not signed in
            {% endif %}
          </div>
        </div>
        {% if user.is_authenticated %}
          <a class="logout" href="{% url 'logout' %}" title="Sign out"><i class="bi bi-box-arrow-right"></i></a>
        {% else %}
          <a class="logout" href="{% url 'login' %}" title="Sign in"><i class="bi bi-box-arrow-in-right"></i></a>
        {% endif %}
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="d-flex align-items-center justify-content-between">
          <h1 class="h4 mb-0">Analytics</h1>
          <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'dashboard' %}">
              <i class="bi bi-speedometer2 me-1"></i>Dashboard
            </a>
          </div>
        </div>
      </header>
      <section class="container py-4">
        <div class="row g-3 mb-3">
          <div class="col-12 col-sm-6 col-lg-4 col-xl-2"><div class="card shadow-sm"><div class="card-body stat"><div class="stat-title">Total Items</div><div class="stat-value">{{ metrics.total_items }}</div><div class="stat-delta text-success"><i class="bi bi-arrow-up-right"></i></div></div></div></div>
          <div class="col-12 col-sm-6 col-lg-4 col-xl-2"><div class="card shadow-sm"><div class="card-body stat"><div class="stat-title">Low Stock</div><div class="stat-value">{{ metrics.low_stock }}</div><div class="stat-delta text-warning"><i class="bi bi-exclamation-circle"></i> Monitor</div></div></div></div>
          <div class="col-12 col-sm-6 col-lg-4 col-xl-2"><div class="card shadow-sm"><div class="card-body stat"><div class="stat-title">Out of Stock</div><div class="stat-value">{{ metrics.out_of_stock }}</div><div class="stat-delta text-danger"><i class="bi bi-dash-circle"></i> Reorder</div></div></div></div>
          <div class="col-12 col-sm-6 col-lg-4 col-xl-2"><div class="card shadow-sm"><div class="card-body stat"><div class="stat-title">Inventory Value</div><div class="stat-value">${{ metrics.inventory_value }}</div><div class="stat-delta text-success"><i class="bi bi-arrow-up-right"></i></div></div></div></div>
          <div class="col-12 col-sm-6 col-lg-4 col-xl-2"><div class="card shadow-sm"><div class="card-body stat"><div class="stat-title">New Items (7d)</div><div class="stat-value">{{ metrics.new_items_7d }}</div><div class="stat-delta text-success"><i class="bi bi-check-circle"></i> OK</div></div></div></div>
          <div class="col-12 col-sm-6 col-lg-4 col-xl-2"><div class="card shadow-sm"><div class="card-body stat"><div class="stat-title">Categories</div><div class="stat-value">{{ metrics.categories }}</div><div class="stat-delta text-muted"><i class="bi bi-three-dots"></i></div></div></div></div>
        </div>
        <div class="row g-3">
          <div class="col-12 col-xl-6"><div class="card shadow-sm h-100"><div class="card-body"><h2 class="h6 mb-3">Items by Stock Status</h2><canvas id="statusChart" height="160"></canvas></div></div></div>
          <div class="col-12 col-xl-6"><div class="card shadow-sm h-100"><div class="card-body"><h2 class="h6 mb-3">Items by Category</h2><canvas id="categoryChart" height="160"></canvas></div></div></div>
        </div>
      </section>
    </main>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    // Chart for stock status
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
      type: 'bar',
      data: {
        labels: ['In Stock', 'Low Stock', 'Out of Stock'],
        datasets: [{
          data: [{{ in_stock_count }}, {{ low_stock_count }}, {{ out_stock_count }}],
          backgroundColor: ['#198754', '#FFC107', '#DC3545']
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
      }
    });

    // Chart for category distribution
    const catCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryLabels = [{% for c in cat_counts %}'{{ c.name }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
    const categoryData = [{% for c in cat_counts %}{{ c.total }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    new Chart(catCtx, {
      type: 'bar',
      data: {
        labels: categoryLabels,
        datasets: [{ data: categoryData, backgroundColor: '#0D6EFD' }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
      }
    });
  </script>
{% endblock %}
